AWSTemplateFormatVersion: '2010-09-09'
Description: 'Main CloudFormation stack for the Crypto Trading System. It orchestrates all other nested stacks.'

Parameters:
  ProjectName:
    Type: String
    Default: 'CryptoTradingSystem'
    Description: 'A prefix for all created resources.'

Resources:
  # Pilha de IAM
  IAMStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: './iam.yaml'
      Parameters:
        ProjectName: !Ref ProjectName

  # Pilha de Storage
  StorageStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: './storage.yaml'
      Parameters:
        ProjectName: !Ref ProjectName

  # Pilha de Processing
  ProcessingStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: './processing.yaml'
      Parameters:
        ProjectName: !Ref ProjectName
        LambdaExecutionRoleArn: !GetAtt IAMStack.Outputs.LambdaExecutionRoleArn
    DependsOn:
      - IAMStack
      - StorageStack

Outputs:
  DataBucketName:
    Description: 'S3 Bucket for data storage'
    Value: !GetAtt StorageStack.Outputs.DataBucketName
  StrategyTableName:
    Description: 'DynamoDB table for strategies'
    Value: !GetAtt StorageStack.Outputs.StrategyTableName
  ValidationQueueUrl:
    Description: 'URL of the SQS validation queue'
    Value: !GetAtt ProcessingStack.Outputs.ValidationQueueUrl
